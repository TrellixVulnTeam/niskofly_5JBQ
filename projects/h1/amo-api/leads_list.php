<?php$yesterday  = mktime(0, 0, 0, date("m")  , date("d")-1, date("Y"));$date = date('D, d M Y H:i:s',$yesterday);//die(var_dump('IF-MODIFIED-SINCE: '.$date.' UTC'));$limit_rows = 500;$limit_offset = 0;$current_deals = [];$Response = true;while ($limit_offset < 3000 && $Response !== NULL) {#Формируем ссылку для запроса    $link = 'https://' . $subdomain . '.amocrm.ru/api/v2/leads?limit_rows=' . $limit_rows . '&limit_offset=' . $limit_offset;    $curl = curl_init(); #Сохраняем дескриптор сеанса cURL#Устанавливаем необходимые опции для сеанса cURL    curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);    curl_setopt($curl, CURLOPT_USERAGENT, 'amoCRM-API-client/1.0');    curl_setopt($curl, CURLOPT_URL, $link);    curl_setopt($curl, CURLOPT_HTTPHEADER, array('Content-Type: application/json'));    curl_setopt($curl, CURLOPT_HEADER, false);    curl_setopt($curl, CURLOPT_HTTPHEADER, array('IF-MODIFIED-SINCE: ' . $date . ' UTC'));    curl_setopt($curl, CURLOPT_COOKIEFILE, dirname(__FILE__) . '/cookie.txt'); #PHP>5.3.6 dirname(__FILE__) -> __DIR__    curl_setopt($curl, CURLOPT_COOKIEJAR, dirname(__FILE__) . '/cookie.txt'); #PHP>5.3.6 dirname(__FILE__) -> __DIR__    curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, 0);    curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, 0);    $out = curl_exec($curl); #Инициируем запрос к API и сохраняем ответ в переменную    $code = curl_getinfo($curl, CURLINFO_HTTP_CODE);    CheckCurlResponse($code);    /**     * Данные получаем в формате JSON, поэтому, для получения читаемых данных,     * нам придётся перевести ответ в формат, понятный PHP     */    $Response = json_decode($out, true);    if ($Response !== NULL){        $items = $Response['_embedded']['items'];        foreach ($items as $item) {            if (!empty($item['custom_fields'])) {                foreach ($item['custom_fields'] as $custom_field) {                    if ($custom_field['id'] == '486295') {                        $contact = NULL;                        $order = NULL;                        if (isset($item['contacts']['_links'])) {                            #Формируем ссылку для запроса                            $link = 'https://' . $subdomain . '.amocrm.ru' . $item['contacts']['_links']['self']['href'];                            $curl = curl_init(); #Сохраняем дескриптор сеанса cURL                            #Устанавливаем необходимые опции для сеанса cURL                            curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);                            curl_setopt($curl, CURLOPT_USERAGENT, 'amoCRM-API-client/1.0');                            curl_setopt($curl, CURLOPT_URL, $link);                            curl_setopt($curl, CURLOPT_HTTPHEADER, array('Content-Type: application/json'));                            curl_setopt($curl, CURLOPT_HEADER, false);                            curl_setopt($curl, CURLOPT_COOKIEFILE, dirname(__FILE__) . '/cookie.txt'); #PHP>5.3.6 dirname(__FILE__) -> __DIR__                            curl_setopt($curl, CURLOPT_COOKIEJAR, dirname(__FILE__) . '/cookie.txt'); #PHP>5.3.6 dirname(__FILE__) -> __DIR__                            curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, 0);                            curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, 0);                            $out = curl_exec($curl); #Инициируем запрос к API и сохраняем ответ в переменную                            $code = curl_getinfo($curl, CURLINFO_HTTP_CODE);                            CheckCurlResponse($code);                            /**                             * Данные получаем в формате JSON, поэтому, для получения читаемых данных,                             * нам придётся перевести ответ в формат, понятный PHP                             */                            $contact = json_decode($out, true);                            //die(var_dump(json_encode($contact)));                           /* $order['id'] = $item['id'];                            $order['updated_at'] = $item['updated_at'];                            $order['status_id'] = $item['status_id'];                            $order['name_lid'] = $item['name'];*/                            $order['name'] = isset($contact['_embedded']['items'][0]['name']) ? $contact['_embedded']['items'][0]['name'] : '';                            $order['first_name'] = isset($contact['_embedded']['items'][0]['first_name']) ? $contact['_embedded']['items'][0]['first_name'] : $contact['_embedded']['items'][0]['name'];                            $order['last_name'] = isset($contact['_embedded']['items'][0]['last_name']) ? $contact['_embedded']['items'][0]['last_name']: '';                            foreach ($contact['_embedded']['items'][0]['custom_fields'] as $custom_field_phone) {                                if ($custom_field_phone['id'] == '79667') {                                    $order['phone'] = $custom_field_phone['values'][0]['value'];                                }                            }                            foreach ($contact['_embedded']['items'][0]['custom_fields'] as $custom_field_email) {                                if ($custom_field_email['id'] == '79669') {                                    $order['email'] = $custom_field_email['values'][0]['value'];                                }                            }                        }                        foreach ($item['custom_fields'] as $custom_field_course){                            if ($custom_field_course['id'] == '486293') {                                $order['course'] = $custom_field_course['values'][0]['value'] ;                            }                        }                        $order['price'] = $item['sale'];                        foreach ($item['custom_fields'] as $custom_field_message){                            if ($custom_field_message['id'] == '474093') {                                $order['message'] = $custom_field_message['values'][0]['value'] ;                            }                        }                        $order['created_at'] = $item['created_at'];                        $item['order'] = $order;                        array_push($current_deals, $item);                        //die(var_dump($item));                    }                }            }        }    }    $limit_offset = $limit_rows + $limit_offset;}return $current_deals;?>